'use client'

import { useBlockNumber, useReadContract } from 'wagmi'

import { useQueryClient } from '@tanstack/react-query'
import { useEffect } from 'react'
import { type RP2ClaimChainId, isRP2ClaimChainId } from '../types'
import { ClaimContractConfig } from './useRP2ExploitClaim'

interface UseRP2ExploitIsClaimed {
  chainId: RP2ClaimChainId
  index: number
}
export const useRP2ExploitIsClaimed = ({
  index,
  chainId,
}: UseRP2ExploitIsClaimed) => {
  const queryClient = useQueryClient()
  const query = useReadContract({
    ...ClaimContractConfig(chainId),
    chainId,
    functionName: 'isClaimed',
    args: [BigInt(index)],
    query: {
      enabled: isRP2ClaimChainId(chainId),
    },
  })

  const { data: blockNumber } = useBlockNumber({ chainId, watch: true })

  useEffect(() => {
    if (blockNumber) {
      queryClient.invalidateQueries(
        { queryKey: query.queryKey },
        { cancelRefetch: false },
      )
    }
  }, [blockNumber, queryClient, query.queryKey])

  return query
}
